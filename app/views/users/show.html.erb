<% provide(:title, @user.name) %>
<table class="table table-bordered table-striped table-condensed">
  
  <thead>
   <div class = "header">  
    <tr>
      <th class="table-header">
        <%= link_to "←",user_url(params: { id: @user.id, first_day: @first_day.prev_month }),  
            style:"color:black", class: 'btn' %>  
            
              <%= @first_day.strftime("%Y年%m月") %> 時間管理表 
        <%= link_to "→", user_url(params: { id: @user.id, first_day: @first_day.next_month }), 
            style:"color:black", class: 'btn' %>
     </th>
     
     <th class="table-header">
        指定勤務時間:<%= format("%.2f", ((@user.design_work_hour.hour*60.0) + @user.design_work_hour.min)/60) if !@user.nil? && !@user.design_work_hour.nil? %></th>
     <th colspan="3" class="table-header">
        基本時間:<%= format("%.2f", ((@user.basic_work_hour.hour*60.0) + @user.basic_work_hour.min)/60) if !@user.nil? && !@user.basic_work_hour.nil? %></th>
     </th>
     <th class="table-header">初日: <%= @first_day %></th>
    </tr>
    
    <tr>
      <th class="table-header">所属: <%= @user.affiliation %> </th>
      <th class="table-header">氏名: <%= @user.name %></th>
      <th class="table-header">コード:</th>
      <th class="table-header"></th>
      <th class="table-header">出勤日数:<%= @attendance_days %>日</th>
      <th class="table-header">締め: <%= @last_day %></th>
    </tr>
  </div>  
  </thead>
</table>
<!--attendance_edit_pathに、userのidと今月の値を渡す-->
<%= link_to "勤怠を編集", edit_attendance_path(@attendances, params: { id: @user.id, first_day: @first_day }), :style=>"color:white;", class: "btn btn-sm btn-primary"  %>
<%= link_to "CSV出力", att_export_path(@attendance, params: { id: @user.id, first_day: @first_day, format: :csv}), :style=>"color:white;", class: "btn btn-sm btn-primary" %>
<table class="table table-bordered table-striped table-condensed">
  <thead align="center">
    <tr>
      <th rowspan="2" class="table-header"　align="center">残業申請</th>
      <th rowspan="2" class="table-header"　align="center">日付</th>
      <th rowspan="2" class="table-header"　align="center">曜日</th>
      <th colspan="3" class="table-header"　align="center">出社</th>
      <th colspan="3" class="table-header"　align="center">退社</th>
      <th rowspan="2" class="table-header"　align="center">在社時間</th>
      <th rowspan="2" class="table-header"　align="center">備考</th>
    </tr>
    <tr>   
     <th class="table-header">時</th>
     <th class="table-header">分</th>
     <th class="table-header">  </th>
     <th class="table-header">時</th>
     <th class="table-header">分</th>
     <th class="table-header">  </th>
    </tr>
  </thead>
  <tbody>
    <!-- users_controller.rbの@attendancesの中身を見にいく-->
    <% total_present_time = 0 %>
    <% @attendances.each do |attendance| %>
      <tr>
        <!-- 残業申請 -->
        <td class="table-body">
          <button type = "button" class= "btn-primary btn-sm" data-toggle="modal" data-target=#Modal>残業申請</button>
          <div class="modal fade" id="Modal">
            <!-- モーダルコンテント:モーダルに表示させる内容-->
            <div class="modal-content" id="attendance<%= attendance.id %>" >
              <!-- モーダルコンテントのヘッダー部分-->
              <div class="modal-header">
                <h3 class="modal-title" align="center">【残業申請】</h3>
                <!--id,user_id,first_dayなど呼び出し（３行ほど）-->
                <!-- &timesは「×ボタン」の表示-->        
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>
              <div class="modal-body">
                <table class="table table-bordered table-striped table-condensed">
                  <thead>
                    <tr>
                      <th class="table-header">日付</th>
                      <th class="table-header">曜日</th>
                      <th class="table-header">終了予定時間</th>
                      <th class="table-header">翌日</th>
                      <th class="table-header">業務処理内容</th>
                      <th class="table-header">指示者確認㊞</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="table-body"><%= attendance.day.month %>/<%= attendance.day.day %></td>
                      <td class="table-body"><%= @day_of_week[attendance.day.wday] %></td>
                      <!-- 終了予定時間の表示  -->
                      <td class="table-body">
                      </td>
                      <!-- 翌日のチェックボックスの表示  -->
                      <td class="table-body">
                        <%= check_box_tag :check %>
                      </td>
                      <!-- 業務処理内容の表示  -->
                      <td class="table-body">
                      </td>
                      <!-- 指示者確認印の表示  -->
                      <td class="table-body">
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!--<div class="modal-footer">-->
                 <button class="btn btn-lg btn-primary">変更を送信する</button>
              <!--</div>-->
            </div>
          </div>
        </td>
        <!--日付-->
        <td class="table-body">
          <%= attendance.day.month %>/<%= attendance.day.day %>
        </td>
        <!--曜日-->
        <td class="table-body">
          <%= @day_of_week[attendance.day.wday] %>
        </td>
        <!-- 出社時間の表示  -->
        <td class="table-body">
          <%= attendance.attendance_time.hour if !attendance.attendance_time.nil? %>
            <% if attendance.day == DateTime.new(DateTime.now.year, DateTime.now.month, DateTime.now.day) && attendance.attendance_time.nil?%>
             <%= link_to "出社", attendance_path(params: {attendance: {id:attendance.id , attendance_time:DateTime.current}}), :method => :post %>
            <% end %>                           
        </td>
        <td class="table-body">
          <%= attendance.attendance_time.min if !attendance.attendance_time.nil? %>
        </td>
        <td class="table-body">
        </td>
        <!-- 退社時間の表示  -->
        <td class="table-body">
          <%= attendance.leaving_time.hour if !attendance.leaving_time.nil? %>
           <% if attendance.day == Date.current && attendance.attendance_time.present? && attendance.leaving_time.nil? %>
              <%= link_to "退社", leaving_path(params: {attendance: {id:attendance.id , leaving_time:DateTime.current}}), :method => :post %>
           <% end %>
        </td>
        <td class="table-body">
          <%= attendance.leaving_time.min if !attendance.leaving_time.nil? %>
        </td>
        <td class="table-body">
        </td>

        <!-- 在社時間の表示  -->
        <td class="table-body">
          <% if !attendance.attendance_time.nil? && !attendance.leaving_time.nil? %>
           <% present_time = (attendance.leaving_time - attendance.attendance_time) / 3600 %>
           <% total_present_time += present_time %>
           <%=format("%.2f", present_time) %>
          <% end %>
        </td>
        <!-- 備考の表示  -->
        <td class="table-body">
        </td>
      </tr>
    <% end %>
      <tr>
        <td colspan="2" class="table-body"></td>
        <td colspan="6" class="table-body"></td>
        <!-- 合計在社時間の表示 -->
        <td class="table-body">
        <%= format("%.2f", total_present_time) %>
        </td>
        <td colspan="1" class="table-body"></td>
      </tr>
  </tbody>
</table>

